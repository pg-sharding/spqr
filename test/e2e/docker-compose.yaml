version: '3.9'

services:
  shard1:
    image:
      spqr_shardbase
    environment:
      - POSTGRES_USER=regress
      - POSTGRES_DB=regress
    ports:
      - "7432:6432"
  shard2:
    image:
      spqr_shardbase
    environment:
      - POSTGRES_USER=regress
      - POSTGRES_DB=regress
    ports:
      - "7433:6432"

  router:
    build:
      dockerfile: ./docker/router/Dockerfile
      context: ../../
    ports:
      - "6432:6432"
    environment:
      - SPQR_CONFIG=/spqr/test/e2e/conf/router.yaml
    depends_on:
      - "shard1"
      - "shard2"

  coordinator:
    build:
      dockerfile: ./docker/coordinator/Dockerfile
      context: ../../
    ports:
      - "7002:7002"
      - "7003:7003"
    environment:
      - SPQR_CONFIG=/spqr/test/e2e/conf/coordinator.yaml
    depends_on:
      - "router"
      - "qdb01"

  qdb01:
    image: 'bitnami/etcd:latest'
    hostname: spqr_qdb_0_1
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_LOG_LEVEL: "debug"
    ports:
      - "2379:2379"

  e2e:
    build:
      context: .
    hostname: spqr_1
    depends_on:
      - "coordinator"
