services:
  shard1:
    image: spqr-shard-image
    environment:
      - POSTGRES_USER=regress
      - POSTGRES_DB=regress
    ports:
      - "7432:6432"
    hostname: spqr_shard_1
    container_name: spqr_shard_1
    healthcheck:
      test: psql -h spqr_shard_1 -p 6432 -U regress -d regress
      interval: 10s
      timeout: 3s
      retries: 50
  shard2:
    image: spqr-shard-image
    environment:
      - POSTGRES_USER=regress
      - POSTGRES_DB=regress
    ports:
      - "7433:6432"
    hostname: spqr_shard_2
    container_name: spqr_shard_2
    healthcheck:
      test: psql -h spqr_shard_2 -p 6432 -U regress -d regress
      interval: 10s
      timeout: 3s
      retries: 50
  shard3:
    image: spqr-shard-image
    environment:
      - POSTGRES_USER=regress
      - POSTGRES_DB=regress
    ports:
      - "7434:6432"
    hostname: spqr_shard_3
    container_name: spqr_shard_3
    healthcheck:
      test: psql -h spqr_shard_3 -p 6432 -U regress -d regress
      interval: 10s
      timeout: 3s
      retries: 50
  shard4:
    image: spqr-shard-image
    environment:
      - POSTGRES_USER=regress
      - POSTGRES_DB=regress
    ports:
      - "7435:6432"
    hostname: spqr_shard_4
    container_name: spqr_shard_4
    healthcheck:
      test: psql -h spqr_shard_4 -p 6432 -U regress -d regress
      interval: 10s
      timeout: 3s
      retries: 50
  router:
    build:
      dockerfile: ./docker/router/Dockerfile
      context: ../../..
    ports:
      - "6432:6432"
    environment:
      - ROUTER_CONFIG=/spqr/test/regress/conf/router.yaml
      - ROUTER_LOG=/var/log/spqr-router.log
    hostname: regress_router
    container_name: regress_router
    depends_on:
      shard1:
        condition: service_healthy
      shard2:
        condition: service_healthy
      shard3:
        condition: service_healthy
      shard4:
        condition: service_healthy

  coordinator:
    build:
      dockerfile: ./docker/coordinator/Dockerfile
      context: ../../..
    ports:
      - "7002:7002"
      - "7003:7003"
    environment:
      - COORDINATOR_CONFIG=/spqr/test/regress/conf/coordinator.yaml
    hostname: regress_coordinator
    container_name: regress_coordinator
    depends_on:
      - "router"
      - "qdb01"

  qdb01:
    image: 'quay.io/coreos/etcd:v3.6.4'
    hostname: regress_qdb_0_1
    container_name: regress_qdb_0_1
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_LOG_LEVEL: "debug"
    ports:
      - "2379:2379"
    entrypoint: ["/usr/local/bin/etcd", "--advertise-client-urls", "http://regress_qdb_0_1:2379", "--listen-client-urls", "http://0.0.0.0:2379"]

  regress:
    build:
      context: https://github.com/pg-sharding/jdbc-spqr.git
    environment:
      - PG_HOST=regress_router
      - PG_PORT=6432
      - PG_USER=regress
      - PG_DATABASE=regress
      - PGPASSWORD=12345678
    hostname: regress_tests
    container_name: regress_tests
    depends_on:
      - coordinator
