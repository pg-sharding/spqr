\c spqr-console

		SPQR router admin console
	Here you can configure your routing rules
------------------------------------------------
	You can find documentation here 
https://github.com/pg-sharding/spqr/tree/master/docs

CREATE DISTRIBUTION d COLUMN TYPES INT HASH;
   add distribution   
----------------------
 distribution id -> d
(1 row)

CREATE RELATION r (i HASH murmur);
     attach table     
----------------------
 relation name   -> r
 distribution id -> d
(2 rows)

CREATE RELATION r2 (i HASH murmur);
     attach table      
-----------------------
 relation name   -> r2
 distribution id -> d
(2 rows)

CREATE RELATION r3 (i HASH murmur);
     attach table      
-----------------------
 relation name   -> r3
 distribution id -> d
(2 rows)

CREATE UNIQUE INDEX ui ON r COLUMNS (j integer);
   create unique index   
-------------------------
 index ID -> ui
 relation name -> r
 column names  -> j
 column types -> integer
(4 rows)

CREATE UNIQUE INDEX ui1 ON r2 COLUMNS (j integer);
   create unique index   
-------------------------
 index ID -> ui1
 relation name -> r2
 column names  -> j
 column types -> integer
(4 rows)

CREATE UNIQUE INDEX ui2 ON r2 COLUMNS (k integer);
   create unique index   
-------------------------
 index ID -> ui2
 relation name -> r2
 column names  -> k
 column types -> integer
(4 rows)

CREATE UNIQUE INDEX ui3 ON r3 COLUMNS (j integer, k integer);
       create unique index        
----------------------------------
 index ID -> ui3
 relation name -> r3
 column names  -> j, k
 column types -> integer, integer
(4 rows)

CREATE KEY RANGE k4 FROM 3221225472 ROUTE TO sh4;
    add key range    
---------------------
 bound -> 3221225472
(1 row)

CREATE KEY RANGE k3 FROM 2147483648 ROUTE TO sh3;
    add key range    
---------------------
 bound -> 2147483648
(1 row)

CREATE KEY RANGE k2 FROM 1073741824 ROUTE TO sh2;
    add key range    
---------------------
 bound -> 1073741824
(1 row)

CREATE KEY RANGE k1 FROM 0 ROUTE TO sh1;
 add key range 
---------------
 bound -> 0
(1 row)

\c regress
CREATE TABLE r(i int, j int, k int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
-- unique index is actually a reverse index (just another table)
CREATE TABLE ui(j int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE UNIQUE INDEX ON ui USING btree(j);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE TABLE r2(i int, j int, k int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
-- unique index is actually a reverse index (just another table)
CREATE TABLE ui1(j int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE UNIQUE INDEX ON ui1 USING btree(j);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE TABLE ui2(k int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE UNIQUE INDEX ON ui2 USING btree(k);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE TABLE r3(i int, j int, k int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
-- unique index is actually a reverse index (just another table)
CREATE TABLE ui3(j int, k int);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
CREATE UNIQUE INDEX ON ui3 USING btree(j, k);
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
SET __spqr__engine_v2 TO true;
SELECT __spqr__ctid('r');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
SELECT __spqr__ctid('ui');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
INSERT INTO r (i, j, k) VALUES(1, 2, 3);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh3
SELECT __spqr__ctid('r');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
(1 row)

SELECT __spqr__ctid('ui');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j 
--------------+---
 shard sh3    | 2
(1 row)

INSERT INTO r (i, j, k) VALUES(3, 4, 5);
NOTICE: send query to shard(s) : sh3
NOTICE: send query to shard(s) : sh4
SELECT __spqr__ctid('r');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
 shard sh3    | 3 | 4 | 5
(2 rows)

SELECT __spqr__ctid('ui');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j 
--------------+---
 shard sh3    | 2
 shard sh4    | 4
(2 rows)

-- should fail
INSERT INTO r (i, j, k) VALUES(10, 2, 30);
NOTICE: send query to shard(s) : sh4
NOTICE: send query to shard(s) : sh3
ERROR:  client processing error: failed to run inner slice, tx status error: duplicate key value violates unique constraint "ui_j_idx", tx status ACTIVE
WITH s AS (select 1)
INSERT INTO r (i, j, k) VALUES(10, 2, 30);
ERROR:  client processing error: error processing query 'WITH s AS (select 1)
INSERT INTO r (i, j, k) VALUES(10, 2, 30);': too complex query to route, tx status IDLE
INSERT INTO r (i, j, k) VALUES(7, 8, 9) RETURNING *;
ERROR:  client processing error: error processing query 'INSERT INTO r (i, j, k) VALUES(7, 8, 9) RETURNING *;': too complex query to route, tx status IDLE
DELETE FROM r WHERE i = 7;
ERROR:  client processing error: error processing query 'DELETE FROM r WHERE i = 7;': Not implemented, tx status IDLE
UPDATE r SET k = k + 1 WHERE i = 7;
ERROR:  client processing error: error processing query 'UPDATE r SET k = k + 1 WHERE i = 7;': Not implemented, tx status IDLE
-- test with tx block
BEGIN;
INSERT INTO r (i, j, k) VALUES(7, 8, 9);
NOTICE: send query to shard(s) : sh4
NOTICE: send query to shard(s) : sh1
SELECT __spqr__ctid('r');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh4    | 7 | 8 | 9
 shard sh2    | 1 | 2 | 3
 shard sh3    | 3 | 4 | 5
(3 rows)

SELECT __spqr__ctid('ui');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j 
--------------+---
 shard sh4    | 4
 shard sh1    | 8
 shard sh3    | 2
(3 rows)

ROLLBACK;
SELECT __spqr__ctid('r');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
 shard sh3    | 3 | 4 | 5
(2 rows)

SELECT __spqr__ctid('ui');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j 
--------------+---
 shard sh3    | 2
 shard sh4    | 4
(2 rows)

-- test multiple index
SELECT __spqr__ctid('r2');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
SELECT __spqr__ctid('ui1');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
SELECT __spqr__ctid('ui2');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
INSERT INTO r2 (i, j, k) VALUES(1, 2, 3);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh3
NOTICE: send query to shard(s) : sh1
SELECT __spqr__ctid('r2');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
(1 row)

SELECT __spqr__ctid('ui1');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j 
--------------+---
 shard sh3    | 2
(1 row)

SELECT __spqr__ctid('ui2');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | k 
--------------+---
 shard sh1    | 3
(1 row)

-- should fail
INSERT INTO r2 (i, j, k) VALUES(1, 2, 3);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh3
ERROR:  client processing error: failed to run inner slice, tx status error: duplicate key value violates unique constraint "ui1_j_idx", tx status ACTIVE
INSERT INTO r2 (i, j, k) VALUES(4, 5, 6);
NOTICE: send query to shard(s) : sh4
NOTICE: send query to shard(s) : sh4
NOTICE: send query to shard(s) : sh1
SELECT __spqr__ctid('r2');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
 shard sh4    | 4 | 5 | 6
(2 rows)

SELECT __spqr__ctid('ui1');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j 
--------------+---
 shard sh3    | 2
 shard sh4    | 5
(2 rows)

SELECT __spqr__ctid('ui2');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | k 
--------------+---
 shard sh1    | 3
 shard sh1    | 6
(2 rows)

-- test multi-column index
SELECT __spqr__ctid('r3');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
SELECT __spqr__ctid('ui3');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
INSERT INTO r3 (i, j, k) VALUES (1, 2, 3);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh1
INSERT INTO r3 (i, j, k) VALUES (2, 3, 2);
NOTICE: send query to shard(s) : sh4
NOTICE: send query to shard(s) : sh4
SELECT __spqr__ctid('r3');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
 shard sh4    | 2 | 3 | 2
(2 rows)

SELECT __spqr__ctid('ui3');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j | k 
--------------+---+---
 shard sh1    | 2 | 3
 shard sh4    | 3 | 2
(2 rows)

-- should fail
INSERT INTO r3 (i, j, k) VALUES (1, 2, 3);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh1
ERROR:  client processing error: failed to run inner slice, tx status error: duplicate key value violates unique constraint "ui3_j_k_idx", tx status ACTIVE
-- should fail
INSERT INTO r3 (i, j, k) VALUES (1, 3, 2);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh4
ERROR:  client processing error: failed to run inner slice, tx status error: duplicate key value violates unique constraint "ui3_j_k_idx", tx status ACTIVE
INSERT INTO r3 (i, j, k) VALUES (1, 2, 2);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh4
INSERT INTO r3 (i, j, k) VALUES (1, 3, 3);
NOTICE: send query to shard(s) : sh2
NOTICE: send query to shard(s) : sh2
SELECT __spqr__ctid('r3');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | i | j | k 
--------------+---+---+---
 shard sh2    | 1 | 2 | 3
 shard sh2    | 1 | 2 | 2
 shard sh2    | 1 | 3 | 3
 shard sh4    | 2 | 3 | 2
(4 rows)

SELECT __spqr__ctid('ui3');
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
 __spqr__ctid | j | k 
--------------+---+---
 shard sh1    | 2 | 3
 shard sh2    | 3 | 3
 shard sh4    | 3 | 2
 shard sh4    | 2 | 2
(4 rows)

DROP TABLE r;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
DROP TABLE ui;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
DROP TABLE r2;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
DROP TABLE ui1;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
DROP TABLE ui2;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
DROP TABLE r3;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
DROP TABLE ui3;
NOTICE: send query to shard(s) : sh1,sh2,sh3,sh4
\c spqr-console

		SPQR router admin console
	Here you can configure your routing rules
------------------------------------------------
	You can find documentation here 
https://github.com/pg-sharding/spqr/tree/master/docs

DROP DISTRIBUTION ALL CASCADE;
  drop distribution   
----------------------
 distribution id -> d
(1 row)

