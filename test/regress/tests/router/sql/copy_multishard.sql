\c spqr-console
-- SETUP
CREATE DISTRIBUTION ds1 COLUMN TYPES int hash;

-- MURMUR hash reduces input to one uint32 integer
-- so we route on the set of all unsigned 32-bit integers (0 to 4294967295)
CREATE KEY RANGE krid2 FROM 2147483648 ROUTE TO sh2 FOR DISTRIBUTION ds1;
CREATE KEY RANGE krid1 FROM 0 ROUTE TO sh1 FOR DISTRIBUTION ds1;

ALTER DISTRIBUTION ds1 ATTACH RELATION xx DISTRIBUTION KEY i HASH FUNCTION MURMUR;

-- TEST
\c regress

SET __spqr__engine_v2 TO true;

CREATE TABLE xx (i bigint, j bigint CHECK(j != 11));

COPY xx (i, j) FROM STDIN WITH DELIMITER '|';
1|1
2|2
3|3
4|4
5|5
6|6
7|7
8|8
9|9
10|10
4294967296|4294967296
4294967297|4294967297
72057594037927936|72057594037927936
72057594037927937|72057594037927937
72057594037927938|72057594037927938
144115188075855872|144115188075855872
144115188075855871|144115188075855871
9223372036854775807|9223372036854775807
9223372036854775806|9223372036854775806
\.

-- check schema-qualified name
COPY public.xx (i, j) FROM STDIN WITH DELIMITER '|';
\.

INSERT INTO xx (i, j) VALUES(1,1);
INSERT INTO xx (i, j) VALUES(2,2);
INSERT INTO xx (i, j) VALUES(3,3);
INSERT INTO xx (i, j) VALUES(4,4);
INSERT INTO xx (i, j) VALUES(5,5);
INSERT INTO xx (i, j) VALUES(6,6);
INSERT INTO xx (i, j) VALUES(7,7);
INSERT INTO xx (i, j) VALUES(8,8);
INSERT INTO xx (i, j) VALUES(9,9);
INSERT INTO xx (i, j) VALUES(10,10);
INSERT INTO xx (i, j) VALUES(4294967296,4294967296);
INSERT INTO xx (i, j) VALUES(4294967297,4294967297);
INSERT INTO xx (i, j) VALUES(4294967298,4294967298);
INSERT INTO xx (i, j) VALUES(144115188075855872,144115188075855872);
INSERT INTO xx (i, j) VALUES(144115188075855871,144115188075855871);
INSERT INTO xx (i, j) VALUES(9223372036854775807,9223372036854775807);
INSERT INTO xx (i, j) VALUES(9223372036854775806,9223372036854775806);

TABLE xx /* __spqr__execute_on: sh1 */;
TABLE xx /* __spqr__execute_on: sh2 */;

TRUNCATE xx;

COPY xx (i, j) FROM STDIN WITH DELIMITER '|';
9223372036854775806|9223372036854775806
9223372036854775807|9223372036854775807
1|11
\.

TABLE xx;

BEGIN;

COPY xx (i, j) FROM STDIN WITH DELIMITER '|' /*__spqr__engine_v2: true*/;
9223372036854775806|9223372036854775806
9223372036854775807|9223372036854775807
1|11
\.

ROLLBACK;

TABLE xx;

BEGIN;

COPY xx (i, j) FROM STDIN WITH DELIMITER '|' /*__spqr__engine_v2: true*/;
9223372036854775806|9223372036854775806
9223372036854775807|9223372036854775807
\.

ROLLBACK;

TABLE xx;

SET __spqr__engine_v2 TO false;
DROP TABLE xx;

\c spqr-console
DROP DISTRIBUTION ALL CASCADE;
