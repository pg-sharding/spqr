---
title: 'SPQR Infra Mode'
description: 'Combined router and coordinator deployment for resource efficiency'
---

## Overview

SPQR Infra mode is a special deployment where each `spqr-router` instance acts as **both a router and a coordinator** in a single binary. This mode is ideal when you want to save CPU and memory resources or simplify your deployment architecture.

In SPQR Infra mode:
- A single `spqr-router` binary provides both routing and coordination functions
- Multiple instances form a distributed consensus group
- An etcd cluster is required for distributed state
- You should run an odd number of instances (1, 3, or 5)
- Reduced operational overhead compared to separate router and coordinator deployments

## Setup

### 1. Deploy etcd Cluster

Set up an etcd cluster for distributed state management. For production, use a 3 or 5-node cluster.

**Example: 3-node etcd cluster**
```bash
# Node 1
etcd --name node1 \
     --listen-client-urls http://0.0.0.0:2379 \
     --advertise-client-urls http://node1:2379 \
     --listen-peer-urls http://0.0.0.0:2380 \
     --initial-advertise-peer-urls http://node1:2380 \
     --initial-cluster node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380

# Node 2
etcd --name node2 \
     --listen-client-urls http://0.0.0.0:2379 \
     --advertise-client-urls http://node2:2379 \
     --listen-peer-urls http://0.0.0.0:2380 \
     --initial-advertise-peer-urls http://node2:2380 \
     --initial-cluster node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380

# Node 3
etcd --name node3 \
     --listen-client-urls http://0.0.0.0:2379 \
     --advertise-client-urls http://node3:2379 \
     --listen-peer-urls http://0.0.0.0:2380 \
     --initial-advertise-peer-urls http://node3:2380 \
     --initial-cluster node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380
```

### 2. Configure SPQR Infra Instance

Create a configuration file:

<Note>
When deploying on separate hosts, each instance can use the same ports. When deploying on the same host (for testing), each instance needs unique ports.
</Note>

```yaml spqr-infra.yaml
host: '0.0.0.0'

router_port: '6432'
admin_console_port: '7432'
grpc_api_port: '7010'

with_coordinator: true
router_mode: PROXY
log_level: info

frontend_rules:
  - db: mydb
    usr: myuser
    pool_mode: TRANSACTION
    auth_rule:
      auth_method: ok

backend_rules:
  - db: mydb
    usr: myuser
    connection_limit: 100
    pool_discard: false
    pool_rollback: true
    auth_rule:
      auth_method: md5
      password: backend_password
```

### 3. Start SPQR Infra Instances

Start each instance with etcd connection details:

```bash
# Define etcd cluster endpoints
ETCD_ENDPOINTS="node1:2379,node2:2379,node3:2379"

# Instance 1
spqr-router run --config spqr-infra.yaml \
  --qdb-endpoints "$ETCD_ENDPOINTS" &

# Instance 2 (different ports if on same host)
spqr-router run --config spqr-infra.yaml \
  --qdb-endpoints "$ETCD_ENDPOINTS" &

# Instance 3 (different ports if on same host)
spqr-router run --config spqr-infra.yaml \
  --qdb-endpoints "$ETCD_ENDPOINTS" &
```

<Note>
The `--qdb-endpoints` flag specifies the etcd cluster endpoints. Alternatively, you can set the `QDB_ENDPOINTS` environment variable.
</Note>

### 4. Configure Sharding Rules

Connect to any instance's admin console:

```bash
psql "host=localhost port=7432 dbname=mydb user=myuser sslmode=disable"
```

Set up your sharding configuration:

```sql
ADD SHARD shard1 WITH HOSTS 'shard1-host:5432';
ADD SHARD shard2 WITH HOSTS 'shard2-host:5432';

CREATE DISTRIBUTION ds1 COLUMN TYPES integer;

ALTER DISTRIBUTION ds1 ATTACH RELATION orders DISTRIBUTION KEY id;
ALTER DISTRIBUTION ds1 ATTACH RELATION order_items DISTRIBUTION KEY order_id;

CREATE KEY RANGE krid1 FROM 0 ROUTE TO shard1 FOR DISTRIBUTION ds1;
CREATE KEY RANGE krid2 FROM 10000 ROUTE TO shard2 FOR DISTRIBUTION ds1;
```

The configuration will be synchronized across all instances via the etcd cluster.

### 5. Connect

Clients can connect to any router instance:

```bash
psql "host=localhost port=6432 dbname=mydb user=myuser sslmode=disable"
```

## Load Balancing

Distribute client connections across instances using:

### DNS Round-Robin
Configure DNS to return multiple A records for your SPQR service name.

### HAProxy/nginx
Use a load balancer to distribute connections:

```haproxy
frontend spqr_frontend
    bind *:6432
    mode tcp
    default_backend spqr_routers

backend spqr_routers
    mode tcp
    balance roundrobin
    option tcp-check
    server spqr1 host1:6432 check
    server spqr2 host2:6432 check
    server spqr3 host3:6432 check
```

## Instance Count Recommendations

### Single Instance (1)
- Development, testing, or very simple deployments
- No high availability, single point of failure

### Three Instances (3) - **Recommended**
- Small to medium production deployments
- Tolerates 1 instance failure
- Good balance of availability and resource usage

### Five Instances (5)
- Larger production deployments
- Tolerates 2 instance failures
- Best for critical applications with strict availability requirements

<Note>
Always maintain an odd number of instances (1, 3, or 5) for proper consensus.
</Note>

## Monitoring

### Check Instance Status

On any instance's admin console:

```sql
SHOW status;
SHOW shards;
SHOW distributions;
SHOW key_ranges;
```

### Verify etcd Connection

```bash
etcdctl --endpoints=node1:2379,node2:2379,node3:2379 endpoint health
```

### Monitor Instance Health

```bash
pg_isready -h localhost -p 6432
psql "host=localhost port=7432 dbname=mydb user=myuser sslmode=disable" -c "SHOW status"
```

## Docker Compose Example

Here's a complete example using Docker Compose:

<Note>
All SPQR instances use the same internal ports (6432, 7432) but are mapped to different host ports (6432-6434, 7432-7434).
</Note>

```yaml docker-compose.yml
version: '3.8'

services:
  etcd1:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      - ETCD_NAME=etcd1
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd1:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd1:2380
    ports:
      - "2379:2379"

  etcd2:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      - ETCD_NAME=etcd2
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd2:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd2:2380

  etcd3:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      - ETCD_NAME=etcd3
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd3:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd3:2380

  spqr1:
    image: spqr:latest
    command: spqr-router run --config /etc/spqr/config.yaml --qdb-endpoints etcd1:2379,etcd2:2379,etcd3:2379
    ports:
      - "6432:6432"
      - "7432:7432"
    volumes:
      - ./spqr-infra.yaml:/etc/spqr/config.yaml
    depends_on:
      - etcd1
      - etcd2
      - etcd3

  spqr2:
    image: spqr:latest
    command: spqr-router run --config /etc/spqr/config.yaml --qdb-endpoints etcd1:2379,etcd2:2379,etcd3:2379
    ports:
      - "6433:6432"
      - "7433:7432"
    volumes:
      - ./spqr-infra.yaml:/etc/spqr/config.yaml
    depends_on:
      - etcd1
      - etcd2
      - etcd3

  spqr3:
    image: spqr:latest
    command: spqr-router run --config /etc/spqr/config.yaml --qdb-endpoints etcd1:2379,etcd2:2379,etcd3:2379
    ports:
      - "6434:6432"
      - "7434:7432"
    volumes:
      - ./spqr-infra.yaml:/etc/spqr/config.yaml
    depends_on:
      - etcd1
      - etcd2
      - etcd3
```

Start the stack:

```bash
docker-compose up -d
```

## Configuration Reference

For complete options:
- [Router Configuration](/configuration/router)
- [Coordinator Configuration](/configuration/coordinator)
