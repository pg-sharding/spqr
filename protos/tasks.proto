syntax = "proto3";

package spqr;

option go_package = "spqr/proto";

import "google/protobuf/empty.proto";

message KeyRangeBound {
  repeated bytes values = 1;
}

enum TaskStatus {
  Planned = 0;
  Split = 1;
  Moved = 2;
}

message MoveTask {
  string ID = 4;
  string keyRangeIdTemp = 1;
  repeated bytes bound = 2;
  TaskStatus status = 3;
  string TaskGroupID = 5;
}

message MoveTaskSelector {
  string ID = 1;
}

message MoveTaskReply {
  MoveTask task = 1;
}

message MoveTasksReply {
  repeated MoveTask tasks = 1;
}

enum JoinType {
  JoinNone = 0;
  JoinLeft = 1;
  JoinRight = 2;
}

enum SplitType {
  SplitLeft = 0;
  SplitRight = 1;
}

enum MoveTaskGroupIssuerType {
  IssuerUnknown = 0;
  IssuerRedistributeTask = 1;
  IssuerBalancerTask = 2;
}

message MoveTaskGroupIssuer {
  MoveTaskGroupIssuerType type = 1;
  string id = 2;
}

message MoveTaskGroup {
  string ID = 13;
  SplitType type = 2;
  string shardIdTo = 4;
  string keyRangeIdFrom = 5;
  string keyRangeIdTo = 6;
  MoveTask currentTask = 7;
  string boundRel = 8;
  double coeff = 9;
  int64 batchSize = 10;
  int64 limit = 11;
  int64 totalKeys = 12;
  MoveTaskGroupIssuer issuer = 14;
}

message GetMoveTaskGroupReply {
  MoveTaskGroup taskGroup = 1;
}

message ListMoveTaskGroupsReply {
  repeated MoveTaskGroup taskGroups = 1;
}

message WriteMoveTaskGroupRequest{
  MoveTaskGroup taskGroup = 1;
}

message MoveTaskGroupSelector {
  string ID = 1;
}

message DropMoveTaskGroupRequest {
  string ID = 1;
  bool cascade = 2;
}

message MoveTaskGroupStatus {
  string state = 1;
  string message = 2; 
}

message GetAllMoveTaskGroupStatusesReply {
  map<string,MoveTaskGroupStatus> statuses = 1;
}

message MoveTaskGroupBoundsCache {
  repeated KeyRangeBound bounds = 1;
  int64 index = 2;
}

service MoveTasksService {
  rpc ListMoveTasks(google.protobuf.Empty) returns (MoveTasksReply) {}
  rpc GetMoveTask(MoveTaskSelector) returns (MoveTaskReply) {}
  rpc RemoveMoveTask(MoveTaskSelector) returns (google.protobuf.Empty) {
    option deprecated = true;
  }
  rpc DropMoveTask(MoveTaskSelector) returns (google.protobuf.Empty) {}

  rpc ListMoveTaskGroups(google.protobuf.Empty) returns (ListMoveTaskGroupsReply) {}
  rpc GetMoveTaskGroup(MoveTaskGroupSelector) returns (GetMoveTaskGroupReply) {}
  rpc WriteMoveTaskGroup(WriteMoveTaskGroupRequest) returns(google.protobuf.Empty) {}
  rpc RemoveMoveTaskGroup(MoveTaskGroupSelector) returns(google.protobuf.Empty) {
    option deprecated = true;
  }
  rpc DropMoveTaskGroup(MoveTaskGroupSelector) returns(google.protobuf.Empty) {
    option deprecated = true;
  }
  rpc DropMoveTaskGroupV2(DropMoveTaskGroupRequest) returns(google.protobuf.Empty) {}
  rpc RetryMoveTaskGroup(MoveTaskGroupSelector) returns(google.protobuf.Empty) {}
  rpc StopMoveTaskGroup(MoveTaskGroupSelector) returns(google.protobuf.Empty) {}
  rpc GetMoveTaskGroupBoundsCache(MoveTaskGroupSelector) returns(MoveTaskGroupBoundsCache) {}

  rpc GetMoveTaskGroupStatus(MoveTaskGroupSelector) returns(MoveTaskGroupStatus) {}
  rpc GetAllMoveTaskGroupStatuses(google.protobuf.Empty) returns(GetAllMoveTaskGroupStatusesReply) {}
}

enum BalancerTaskStatus {
  BalancerTaskPlanned = 0;
  BalancerTaskMoved = 1;
}

message BalancerTask {
  JoinType type = 1;
  string keyRangeIdFrom = 2;
  string keyRangeIdTo = 3;
  string keyRangeIdTemp = 4;
  string shardIdTo = 5;
  int64 keyCount = 6;
  BalancerTaskStatus state = 7;
}

message GetBalancerTaskReply{
  BalancerTask task = 1;
}

message WriteBalancerTaskRequest {
  BalancerTask task = 1;
}

service BalancerTaskService {
  rpc GetBalancerTask(google.protobuf.Empty) returns (GetBalancerTaskReply) {}
  rpc WriteBalancerTask(WriteBalancerTaskRequest) returns (google.protobuf.Empty) {}
  rpc RemoveBalancerTask(google.protobuf.Empty) returns (google.protobuf.Empty) {
    option deprecated = true;
  }
  rpc DropBalancerTask(google.protobuf.Empty) returns (google.protobuf.Empty) {}
}

enum RedistributeTaskState {
  RedistributeTaskPlanned = 0;
  RedistributeTaskMoved = 1;
}

message RedistributeTask {
  string id = 6;
  string keyRangeId = 1;
  string shardId = 2;
  int64 batchSize = 3;
  RedistributeTaskState state = 4;
  string taskGroupId = 5;
  MoveTaskGroup taskGroup = 7;
}

message RedistributeTaskSelector {
  string id = 1;
}

message ListRedistributeTasksReply {
  repeated RedistributeTask tasks = 1;
}

message DropRedistributeTaskRequest {
  string id = 1;
  bool cascade = 2;
}

service RedistributeTaskService {
  rpc ListRedistributeTasks(google.protobuf.Empty) returns (ListRedistributeTasksReply) {}
  rpc DropRedistributeTask(RedistributeTaskSelector) returns (google.protobuf.Empty) {}
  rpc DropRedistributeTaskV2(DropRedistributeTaskRequest) returns (google.protobuf.Empty) {}
  rpc RemoveRedistributeTask(RedistributeTaskSelector) returns (google.protobuf.Empty) {
    option deprecated = true;
  }
}
